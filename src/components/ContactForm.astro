---
import { Icon } from 'astro-icon/components';
import { Schema } from 'astro-seo-schema';
import contactFormModuleUrl from '../scripts/contact-form.js?url';
import contactFormLoaderInline from '../scripts/contact-form-loader.js?raw';
import { BUSINESS_INFO } from '../data/business';

export interface Props {
  id?: string;
  formId?: string;
  fieldIdPrefix?: string;
  title?: string;
  subtitle?: string;
  bgColor?: 'gray' | 'muted' | 'white';
  formBgColor?: 'white' | 'muted';
  includeSchema?: boolean;
}

const {
  id,
  formId = 'contact-form',
  fieldIdPrefix = 'contact-form',
  title = "Get Your Free Quote",
  subtitle = "Fill out the form below and we'll contact you within a few minutes",
  bgColor = 'white',
  formBgColor = 'white',
  includeSchema = true
} = Astro.props;

const getFieldId = (name: string) => `${fieldIdPrefix}-${name}`;

const turnstileSiteKey =
  typeof process.env.turnstile_site_key === 'string'
    ? process.env.turnstile_site_key.trim()
    : '';

const isTurnstileEnabled = Boolean(turnstileSiteKey);
const turnstileScriptSrc = 'https://challenges.cloudflare.com/turnstile/v0/api.js';
---

<section id={id} class={`py-16 ${bgColor === 'white' ? 'bg-white' : 'bg-muted'}`}>
  <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center mb-8">
      <h2 class="text-3xl font-bold text-ink mb-4">{title}</h2>
      <p class="text-xl text-ink/70">{subtitle}</p>
    </div>
    
    <form
      id={formId}
      name="contact"
      method="POST"
      action="/api/contact"
      class={`${formBgColor === 'muted' ? 'bg-muted' : 'bg-white'} rounded-lg shadow-lg px-4 sm:px-5 lg:px-6 py-8`}
      data-contact-form-module={contactFormModuleUrl}
      data-contact-form
      data-turnstile-src={isTurnstileEnabled ? turnstileScriptSrc : undefined}
    >
      <div class="hidden">
        <label>Don't fill this out: <input name="bot-field" /></label>
        <input type="hidden" name="company" data-decoy-company />
        <input type="hidden" name="form_loaded_at" data-form-loaded-at />
      </div>

      {isTurnstileEnabled && (
        <div
          class="cf-turnstile mb-6"
          data-sitekey={turnstileSiteKey}
          data-theme="light"
          data-action="contact"
        ></div>
      )}
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div>
          <label for={getFieldId('name')} class="block text-sm font-medium text-ink mb-2">
            <Icon name="mdi:account" size="16" class="inline mr-1" aria-hidden="true" />
            Full Name *
          </label>
          <input 
            type="text" 
            id={getFieldId('name')} 
            name="name" 
            required 
            aria-describedby="name-required"
            class="w-full px-4 py-3 border border-ink/20 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent"
          />
          <span id="name-required" class="sr-only">Required field</span>
        </div>
        
        <div>
          <label for={getFieldId('phone')} class="block text-sm font-medium text-ink mb-2">
            <Icon name="mdi:phone" size="16" class="inline mr-1" aria-hidden="true" />
            Phone Number *
          </label>
          <input 
            type="tel" 
            id={getFieldId('phone')} 
            name="phone" 
            required 
            aria-describedby="phone-required"
            class="w-full px-4 py-3 border border-ink/20 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent"
          />
          <span id="phone-required" class="sr-only">Required field</span>
        </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div>
          <label for={getFieldId('email')} class="block text-sm font-medium text-ink mb-2">
            <Icon name="mdi:email" size="16" class="inline mr-1" aria-hidden="true" />
            Email Address
          </label>
          <input 
            type="email" 
            id={getFieldId('email')} 
            name="email" 
            class="w-full px-4 py-3 border border-ink/20 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent"
          />
        </div>
        
        <div>
          <label for={getFieldId('zip')} class="block text-sm font-medium text-ink mb-2">
            <Icon name="mdi:map-marker" size="16" class="inline mr-1" aria-hidden="true" />
            ZIP Code *
          </label>
          <input 
            type="text" 
            id={getFieldId('zip')} 
            name="zip" 
            required 
            class="w-full px-4 py-3 border border-ink/20 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent"
          />
        </div>
      </div>
      
      <div class="mb-6">
        <label for={getFieldId('issue')} class="block text-sm font-medium text-ink mb-2">
          <Icon name="mdi:tools" size="16" class="inline mr-1" aria-hidden="true" />
          What's the issue? *
        </label>
        <select 
          id={getFieldId('issue')} 
          name="issue" 
          required 
          class="w-full px-4 py-3 border border-ink/20 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent"
        >
          <option value="">Select an issue...</option>
          <option value="door-wont-open">Door won't open</option>
          <option value="door-wont-close">Door won't close</option>
          <option value="broken-spring">Broken spring</option>
          <option value="opener-problems">Opener problems</option>
          <option value="new-installation">New installation</option>
          <option value="maintenance">Maintenance/tune-up</option>
          <option value="other">Other</option>
        </select>
      </div>
      
      <div class="mb-6">
        <label for={getFieldId('message')} class="block text-sm font-medium text-ink mb-2">
          <Icon name="mdi:message-text" size="16" class="inline mr-1" aria-hidden="true" />
          Additional Details
        </label>
        <textarea 
          id={getFieldId('message')} 
          name="message" 
          rows="4" 
          class="w-full px-4 py-3 border border-ink/20 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent"
          placeholder="Please describe the problem or what you need..."
        ></textarea>
      </div>
      
      <div class="mb-6">
        <label class="flex items-start">
          <input 
            type="checkbox" 
            name="consent" 
            required 
            aria-describedby="consent-required"
            class="mt-1 mr-3 h-4 w-4 text-accent focus:ring-accent border-ink/20 rounded"
          />
          <span class="text-sm text-ink/80">
            I consent to being contacted by Buck Strong Garage Doors regarding my service request. *
          </span>
          <span id="consent-required" class="sr-only">Required field</span>
        </label>
      </div>

      <button type="submit" class="w-full btn-primary text-lg py-4">
        <Icon name="mdi:send" size="20" class="inline mr-2" aria-hidden="true" />
        Send My Request
      </button>

      <p
        data-status
        role="status"
        aria-live="polite"
        class="mt-4 text-sm text-ink/80"
        hidden
      ></p>
    </form>
  </div>
</section>


{includeSchema && (
  <Schema
    item={{
      '@context': 'https://schema.org',
      '@type': 'ContactPoint',
      telephone: BUSINESS_INFO.telephone,
      contactType: 'customer service',
      email: BUSINESS_INFO.email,
      availableLanguage: 'English',
      hoursAvailable: {
        '@type': 'OpeningHoursSpecification',
        dayOfWeek: [
          'Monday',
          'Tuesday',
          'Wednesday',
          'Thursday',
          'Friday',
          'Saturday',
          'Sunday'
        ],
        opens: '00:00',
        closes: '23:59'
      },
      areaServed: {
        '@type': 'City',
        name: 'Cincinnati'
      }
    }}
  />
)}

{isTurnstileEnabled && (
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
)}

<script type="module" is:inline set:html={contactFormLoaderInline}></script>
