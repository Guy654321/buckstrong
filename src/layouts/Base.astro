---
// Load consolidated Tailwind CSS from a single generated stylesheet
import tailwindStylesHref from '../styles/tailwind.css?url';
import { BUSINESS_INFO } from '../data/business';
import speedInsightsLoaderUrl from '../scripts/speed-insights-loader.js?url';
import speedInsightsConfigScriptUrl from '../scripts/speed-insights-config.js?url';
import analyticsLoaderUrl from '../scripts/analytics-consent-loader.js?url';
import IconSprite from '../components/IconSprite.astro';
import CallNowButton from '../components/CallNowButton.astro';
import { buildAbsoluteUrl, getSiteOrigin } from '../utils/site-origin';

export interface Props {
  title?: string;
  description?: string;
  canonical?: string;
  ogImage?: string;
  noindex?: boolean;
  author?: string;
  publishDate?: string;
  modifiedDate?: string;
  articleType?: 'article' | 'website';
  schemaType?: 'LocalBusiness' | 'Service' | 'Article' | 'FAQPage';
  callNowPhoneNumber?: string;
}

const {
  title = "Garage Door Repair Louisville, KY | Derby Strong Garage Doors",
  description = "Same-day garage door repair & installation in Louisville, KY. Springs, openers, cables—fully insured service. Serving all Louisville neighborhoods.",
  canonical,
  ogImage = "/images/derby-city-garage-doors-og.png",
  noindex = false,
  author = "Derby Strong Garage Doors",
  publishDate,
  modifiedDate,
  articleType = 'website',
  schemaType = 'LocalBusiness',
  callNowPhoneNumber
} = Astro.props;

const siteOrigin = getSiteOrigin();

function resolveCanonical(target?: string) {
  let requestPathname: string | undefined;

  try {
    if (Astro.request?.url) {
      requestPathname = new URL(Astro.request.url, siteOrigin).pathname;
    }
  } catch {
    requestPathname = undefined;
  }

  const path =
    target ??
    Astro.url?.pathname ??
    requestPathname ??
    '/';

  return buildAbsoluteUrl(path, siteOrigin);
}

const canonicalHref = resolveCanonical(canonical);
const MAX_TITLE_LENGTH = 70;
const BRAND_KEYWORD = 'Derby Strong';
const BRAND_SHORT = 'Derby Strong Garage Doors';
const LONG_SUFFIX = ' | Derby Strong Garage Doors';
const REPAIR_PHRASE = 'Garage Door Repair';

function shortenToCityRepair(baseTitle: string) {
  const phraseIndex = baseTitle.indexOf(REPAIR_PHRASE);

  if (phraseIndex === -1) {
    return baseTitle.slice(0, MAX_TITLE_LENGTH).trimEnd();
  }

  const cityMatch = baseTitle.match(/in\s+(.+)/i);
  if (cityMatch?.[1]) {
    const location = cityMatch[1].trim();
    const localizedCandidate = `${REPAIR_PHRASE} in ${location}`;

    if (localizedCandidate.length <= MAX_TITLE_LENGTH) {
      return localizedCandidate;
    }

    const availableLength = Math.max(0, MAX_TITLE_LENGTH - (REPAIR_PHRASE.length + 4));
    return `${REPAIR_PHRASE} in ${location.slice(0, availableLength).trimEnd()}`;
  }

  const endIndex = phraseIndex + REPAIR_PHRASE.length;
  return baseTitle.slice(0, endIndex).trimEnd();
}

function enforceMaxLengthWithBrand(title: string) {
  const trimmedTitle = title.trim();
  if (trimmedTitle.length <= MAX_TITLE_LENGTH) {
    return trimmedTitle;
  }

  const segments = trimmedTitle.split('|').map(segment => segment.trim()).filter(Boolean);
  const brandSegment = segments.find(segment => segment.includes(BRAND_KEYWORD)) ?? BRAND_SHORT;
  const primarySegment = segments.find(segment => !segment.includes(BRAND_KEYWORD)) ?? segments[0] ?? trimmedTitle;

  const prioritizedCandidate = `${primarySegment} | ${brandSegment}`;
  if (prioritizedCandidate.length <= MAX_TITLE_LENGTH) {
    return prioritizedCandidate;
  }

  const shortenedPrimary = shortenToCityRepair(primarySegment);
  const shortenedCandidate = `${shortenedPrimary} | ${brandSegment}`;
  if (shortenedCandidate.length <= MAX_TITLE_LENGTH) {
    return shortenedCandidate;
  }

  return shortenedCandidate.slice(0, MAX_TITLE_LENGTH).trimEnd();
}

function buildTitle(baseTitle: string) {
  if (baseTitle.includes(BRAND_KEYWORD)) {
    return enforceMaxLengthWithBrand(baseTitle);
  }

  const longCandidate = `${baseTitle}${LONG_SUFFIX}`;
  if (longCandidate.length <= MAX_TITLE_LENGTH) {
    return longCandidate;
  }

  const trimmedBase = shortenToCityRepair(baseTitle);
  const trimmedWithBrand = `${trimmedBase} | ${BRAND_SHORT}`;
  if (trimmedWithBrand.length <= MAX_TITLE_LENGTH) {
    return trimmedWithBrand;
  }

  return trimmedWithBrand.slice(0, MAX_TITLE_LENGTH).trimEnd();
}

const fullTitle = buildTitle(title);
const ogImageUrl = buildAbsoluteUrl(ogImage, siteOrigin);
const imageAltText = `${fullTitle} - Professional garage door services`;
const businessAddress = BUSINESS_INFO.address;
const isHomepage = Astro.url.pathname === '/';
const faviconVersion = import.meta.env.PUBLIC_FAVICON_VERSION ?? '3';
const faviconHref = `/favicon.ico?v=${faviconVersion}`;
const speedInsightsBasePath = import.meta.env.PUBLIC_VERCEL_OBSERVABILITY_BASEPATH;
const speedInsightsScriptSrc = speedInsightsBasePath
  ? `${speedInsightsBasePath}/speed-insights/script.js`
  : '/_vercel/speed-insights/script.js';
const speedInsightsEndpoint = speedInsightsBasePath
  ? `${speedInsightsBasePath}/speed-insights/vitals`
  : '/_vercel/speed-insights/vitals';
const analyticsMeasurementId = import.meta.env.PUBLIC_GA_MEASUREMENT_ID ?? '';
const analyticsConsentStorageKey =
  import.meta.env.PUBLIC_ANALYTICS_CONSENT_KEY ?? 'derbystrong:analytics-opt-in';
const shouldLoadAnalytics = import.meta.env.PROD && Boolean(analyticsMeasurementId);

const resolvedModifiedDate = modifiedDate ?? new Date().toISOString();

const websiteSchema = JSON.stringify({
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  '@id': `${siteOrigin}#website`,
  url: siteOrigin,
  name: BUSINESS_INFO.name,
  description: 'Professional garage door repair and installation services in Louisville, KY',
  publisher: {
    '@type': 'Organization',
    name: BUSINESS_INFO.name,
    '@id': `${siteOrigin}#business`
  },
  potentialAction: [
    {
      '@type': 'SearchAction',
      target: `${siteOrigin}/search?q={search_term_string}`,
      'query-input': 'required name=search_term_string'
    }
  ]
});

const localBusinessSchema = JSON.stringify({
  '@context': 'https://schema.org',
  '@type': 'LocalBusiness',
  '@id': `${siteOrigin}#business`,
  name: BUSINESS_INFO.name,
  url: canonicalHref,
  image: ogImageUrl,
  logo: BUSINESS_INFO.logo,
  telephone: BUSINESS_INFO.telephone,
  email: BUSINESS_INFO.email,
  priceRange: '$$ - $$$',
  aggregateRating: {
    '@type': 'AggregateRating',
    ratingValue: BUSINESS_INFO.aggregateRating.ratingValue,
    reviewCount: BUSINESS_INFO.aggregateRating.reviewCount
  },
  address: {
    '@type': 'PostalAddress',
    ...businessAddress
  },
  geo: {
    '@type': 'GeoCoordinates',
    latitude: BUSINESS_INFO.geo.latitude,
    longitude: BUSINESS_INFO.geo.longitude
  },
  openingHoursSpecification: [
    {
      '@type': 'OpeningHoursSpecification',
      dayOfWeek: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
      opens: '00:00',
      closes: '23:59'
    }
  ],
  sameAs: [
    'https://www.facebook.com/DerbyStrongGarageDoors',
    'https://www.instagram.com/DerbyStrongGarageDoors'
  ]
});
---

<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="format-detection" content="telephone=yes" />
    <meta name="theme-color" content="#0F3D3E" />
    
    <link rel="icon" type="image/x-icon" href={faviconHref} />
    <link rel="shortcut icon" href={faviconHref} />

    <title>{fullTitle}</title>
    <meta name="description" content={description} />
    <meta name="author" content={author} />
    {publishDate && <meta name="article:published_time" content={publishDate} />}

    <meta name="article:modified_time" content={resolvedModifiedDate} />
    <link rel="canonical" href={canonicalHref} />
    
    {noindex && <meta name="robots" content="noindex, nofollow" />}
    {!noindex && <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />}


    <meta property="og:type" content={articleType} />
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalHref} />
    <meta property="og:image" content={ogImageUrl} />
    <meta property="og:image:secure_url" content={ogImageUrl} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content={imageAltText} />
    <meta property="og:site_name" content="Derby Strong Garage Doors" />
    <meta property="og:locale" content="en_US" />
    {publishDate && <meta property="article:published_time" content={publishDate} />}
    <meta property="article:modified_time" content={resolvedModifiedDate} />
    <meta property="business:contact_data:street_address" content={businessAddress.streetAddress} />
    <meta property="business:contact_data:locality" content={businessAddress.addressLocality} />
    <meta property="business:contact_data:region" content={businessAddress.addressRegion} />
    <meta property="business:contact_data:postal_code" content={businessAddress.postalCode} />
    <meta property="business:contact_data:country_name" content="United States" />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={fullTitle} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImageUrl} />
    <meta name="twitter:image:alt" content={imageAltText} />
    <meta name="twitter:url" content={canonicalHref} />
    <meta name="twitter:site" content="@DerbyStrongGarageDoors" />
    <meta name="twitter:creator" content="@DerbyStrongGarageDoors" />
    
    <link rel="sitemap" type="application/xml" href="/sitemap.xml" />
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link rel="preload" href={tailwindStylesHref} as="style" />
    <link rel="stylesheet" href={tailwindStylesHref} />

    <script type="text/javascript" is:inline>
      (function (c, l, a, r, i, t, y) {
        c[a] =
          c[a] ||
          function () {
            (c[a].q = c[a].q || []).push(arguments);
          };
        t = l.createElement(r);
        t.async = 1;
        t.src = "https://www.clarity.ms/tag/" + i;
        y = l.getElementsByTagName(r)[0];
        y.parentNode.insertBefore(t, y);
      })(window, document, "clarity", "script", "v2utxmkzyu");
    </script>

    {shouldLoadAnalytics && (
      <script
        src={analyticsLoaderUrl}
        defer
        data-measurement-id={analyticsMeasurementId}
        data-consent-key={analyticsConsentStorageKey}
        is:inline
      ></script>
    )}

    <slot name="head" />
    {import.meta.env.PROD && (
      <>
        <script
          src={speedInsightsConfigScriptUrl}
          defer
          data-script-src={speedInsightsScriptSrc}
          data-endpoint={speedInsightsEndpoint}
          is:inline
        ></script>
        <script src={speedInsightsLoaderUrl} defer is:inline></script>
      </>
    )}

    {!isHomepage && (
      <script type="application/ld+json" is:inline set:html={websiteSchema}></script>
    )}
    {schemaType === 'LocalBusiness' && (
      <script type="application/ld+json" is:inline set:html={localBusinessSchema}></script>
    )}
  </head>
  <body class="bg-card text-ink antialiased" data-schema-type={schemaType || undefined}>
    <IconSprite />
    <slot />
    <CallNowButton phoneNumber={callNowPhoneNumber} />

    <div class="sr-only" data-text-ratio-helper>
      <p>
        Derby Strong Garage Doors provides dependable residential and commercial overhead door services across Kentucky.
        Our insured technicians handle garage door repair, opener troubleshooting, spring replacement, cable resets, and
        fully managed door installations. Same-day scheduling is available for safety concerns, broken hardware, and
        malfunctioning openers so homeowners and facilities can keep vehicles and loading areas secure.
      </p>
      <p>
        Every service visit includes a full safety inspection, balance check, and hardware review to catch wear before it
        causes downtime. We stock common rollers, hinges, brackets, weather seals, and LiftMaster-compatible opener parts
        to complete most appointments in a single trip. Property managers can request recurring maintenance for fleets of
        sectional, rolling steel, and high-lift doors to reduce emergency calls and extend equipment life.
      </p>
      <p>
        Our Kentucky team supports neighborhoods throughout Louisville, Lexington, Covington, Florence, Georgetown, and
        nearby markets. Local technicians arrive with transparent pricing, contactless approvals, and digital receipts so
        customers can quickly document repairs for insurance or facility records. We also offer design consultations for
        insulated, carriage-style, and modern glass doors tailored to the region’s climate and architectural styles.
      </p>
      <p>
        Request service online or by phone to connect with a local Derby Strong dispatcher. Whether you need a tune-up,
        smart opener upgrade, commercial dock repair, or a new door installation, our team is ready to protect homes and
        businesses with prompt, courteous support backed by manufacturer-aligned practices and thorough testing.
      </p>
    </div>

  </body>
</html>
