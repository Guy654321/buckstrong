---
import { getCollection, type CollectionEntry } from 'astro:content';
import { Schema } from 'astro-seo-schema';
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';
import defaultHeroImage from '../../assets/images/dillon-kydd-XGvwt544g8k-unsplash.jpg';
import Base from '../../layouts/Base.astro';
import Nav from '../../components/Nav.astro';
import Footer from '../../components/Footer.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import CallNowButton from '../../components/CallNowButton.astro';
import { Icon } from 'astro-icon/components';
import { BUSINESS_INFO } from '../../data/business';
import { buildAbsoluteUrl, getSiteOrigin } from '../../utils/site-origin';

export async function getStaticPaths() {
  try {
    const blogPosts = await getCollection('blog');
    return blogPosts.map((post) => ({
      params: { slug: post.slug },
      props: { post },
    }));
  } catch (error) {
    console.error('Error generating blog post paths:', error);
    return [];
  }
}

type Props = {
  post: CollectionEntry<'blog'>;
};

const { post } = Astro.props as Props;
const { Content } = await post.render();

const siteOrigin = getSiteOrigin();
const displayPhoneNumber = BUSINESS_INFO.telephone;
const telephoneHref = `tel:${displayPhoneNumber.replace(/[^0-9+]/g, '') || displayPhoneNumber}`;

const breadcrumbs = [
  { label: 'Home', href: '/' },
  { label: 'Blog', href: '/blog' },
  { label: post.data.title }
];
const postUrl = buildAbsoluteUrl(`/blog/${post.slug}`, siteOrigin);

// Get related posts (exclude current post)
let relatedPosts: CollectionEntry<'blog'>[] = [];
try {
  const allPosts = await getCollection('blog');
  relatedPosts = allPosts
    .filter(p => p.slug !== post.slug)
    .sort(() => Math.random() - 0.5)
    .slice(0, 2);
} catch (error) {
  console.error('Error loading related posts:', error);
  relatedPosts = [];
}

const heroImageIsString = typeof post.data.image === 'string';
const heroImageMetadata: ImageMetadata =
  typeof post.data.image === 'object' && post.data.image
    ? post.data.image
    : defaultHeroImage;
const heroImageUrl = heroImageIsString
  ? (post.data.image as string)
  : heroImageMetadata.src;
const defaultOgImage = buildAbsoluteUrl(defaultHeroImage.src, siteOrigin);
const ogImage = heroImageUrl
  ? heroImageUrl.startsWith('http')
    ? heroImageUrl
    : buildAbsoluteUrl(heroImageUrl, siteOrigin)
  : defaultOgImage;
---

<Base
  title={`${post.data.title} | Derby Strong Garage Doors Blog`}
  description={post.data.description}
  ogImage={ogImage}
>
  <Nav />
  <Breadcrumbs items={breadcrumbs} />
  
  
  <section class="relative py-20 lg:py-28 text-white overflow-hidden">
    <div class="absolute inset-0">
      {heroImageIsString ? (
        <img
          src={heroImageUrl}
          alt={`${post.data.title} - Professional garage door guidance`}
          class="w-full h-full object-cover"
          width="1200"
          height="675"
          loading="eager"
          decoding="sync"
          fetchpriority="high"
        />
      ) : (
        <Image
          src={heroImageMetadata}
          alt={`${post.data.title} - Professional garage door guidance`}
          class="w-full h-full object-cover"
          width="1200"
          height="675"
          fetchpriority="high"
          loading="eager"
          decoding="sync"
          quality={80}
          sizes="100vw"
        />
      )}
      <div class="absolute inset-0 bg-gradient-to-br from-primary/90 to-primary/75"></div>
    </div>
    
    <div class="relative max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex flex-wrap gap-2 mb-6">
        {post.data.tags.map(tag => (
          <span class="bg-accent text-ink px-3 py-1 rounded-full text-sm font-medium">
            {tag}
          </span>
        ))}
      </div>
      
      <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold mb-6 leading-tight">
        {post.data.title}
      </h1>
      
      <div class="flex items-center text-white/90 mb-8">
        <div class="bg-white/20 w-12 h-12 rounded-full flex items-center justify-center mr-4">
          <Icon name="mdi:account" size="24" aria-hidden="true" />
        </div>
        <div>
          <div class="font-semibold text-lg">{post.data.author}</div>
          <time datetime={post.data.publishDate.toISOString()} class="text-white/80">
            {post.data.publishDate.toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long', 
              day: 'numeric'
            })}
          </time>
        </div>
      </div>
    </div>
  </section>
  
  
  <article class="py-16 bg-card">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      
      <div class="prose prose-xl max-w-none text-ink/80 leading-relaxed">
        <Content />
      </div>
    </div>
  </article>
  
  
  {relatedPosts.length > 0 && (
    <section class="py-20 bg-muted">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
          <h2 class="text-3xl font-bold text-ink mb-4">More Helpful Articles</h2>
          <p class="text-xl text-ink/70">Continue learning with these expert guides</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          {relatedPosts.map((relatedPost) => {
            const relatedImageRaw = relatedPost.data.image;
            const relatedImageIsString = typeof relatedImageRaw === 'string';
            const relatedImageMetadata: ImageMetadata =
              typeof relatedImageRaw === 'object' && relatedImageRaw
                ? relatedImageRaw
                : defaultHeroImage;
            const relatedImageUrl: string = relatedImageIsString
              ? (relatedImageRaw as string)
              : relatedImageMetadata.src;

            return (
              <article class="bg-card rounded-xl shadow-sm ring-1 ring-black/5 overflow-hidden hover:shadow-lg transform-gpu transition-[transform,opacity] duration-300 group composite-surface hover:-translate-y-1 focus-within:-translate-y-1">
                
                <div class="aspect-video overflow-hidden">
                  {relatedImageIsString ? (
                    <img
                      src={relatedImageUrl}
                      alt={`${relatedPost.data.title} - Expert garage door advice and guidance from Derby Strong Garage Doors professionals in Louisville, KY`}
                      class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                      width="400"
                      height="225"
                      loading="lazy"
                      decoding="async"
                      fetchpriority="low"
                    />
                  ) : (
                    <Image
                      src={relatedImageMetadata}
                      alt={`${relatedPost.data.title} - Expert garage door advice and guidance from Derby Strong Garage Doors professionals in Louisville, KY`}
                      class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                      width="400"
                      height="225"
                      loading="lazy"
                      fetchpriority="low"
                      decoding="async"
                      quality={75}
                    />
                  )}
                </div>

                <div class="p-6">
                  <div class="flex flex-wrap gap-2 mb-4">
                    {relatedPost.data.tags.slice(0, 2).map(tag => (
                      <span class="bg-accent/10 text-accent px-3 py-1 rounded-full text-sm font-medium border border-accent/20">
                        {tag}
                      </span>
                    ))}
                  </div>
                  <h3 class="text-xl font-bold text-ink mb-3 group-hover:text-primary transition-colors leading-tight">
                    <a href={`/blog/${relatedPost.slug}`} class="hover:text-primary transition-colors">
                      {relatedPost.data.title}
                    </a>
                  </h3>
                  <p class="text-ink/70 mb-6">
                    {relatedPost.data.description}
                  </p>
                  <a href={`/blog/${relatedPost.slug}`} class="inline-link inline-flex items-center gap-1 group-hover:translate-x-1 transform-gpu transition-[transform,opacity] duration-200 focus-visible:translate-x-1 composite-surface">
                    Read Article
                    <svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      aria-hidden="true"
                      focusable="false"
                    >
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                  </a>
                </div>
              </article>
            );
          })}
        </div>
      </div>
    </section>
  )}
  
  
  <section class="py-16 bg-card">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="bg-muted rounded-2xl p-8">
        <div class="flex items-start space-x-6">
          <div class="bg-accent/20 w-20 h-20 rounded-full flex items-center justify-center flex-shrink-0">
            <Icon name="mdi:office-building" size="40" class="text-accent" aria-hidden="true" />
          </div>
          <div>
            <h3 class="text-2xl font-bold text-ink mb-2">Derby Strong Garage Doors Team</h3>
            <p class="text-ink/70 leading-relaxed">
              Our team of experienced garage door technicians brings over 15 years of experience serving Louisville homeowners.
              We're committed to providing expert advice, quality repairs, and exceptional customer service throughout Metro Louisville.
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>
  
  
  <section class="py-16 bg-primary text-white">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h2 class="text-3xl font-bold mb-6">Need Professional Help?</h2>
      <p class="text-xl text-white/90 mb-8">
        Our expert technicians are ready to help with any garage door issue in Louisville, KY.
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a
          href="/contact"
          class="btn-outline-light text-lg px-8 py-4 bg-white/5 hover:bg-white/10 border-white/80"
        >
          Get Free Quote
        </a>
        <a
          href={telephoneHref}
          class="btn-accent text-lg px-8 py-4 inline-flex items-center justify-center font-semibold w-full sm:w-auto gap-2"
        >
          <Icon name="mdi:phone" size="20" class="inline" aria-hidden="true" />
          <span>Call Now: <span class="nap-phone">{displayPhoneNumber}</span></span>
        </a>
      </div>
    </div>
  </section>
  
  <Footer />
  <CallNowButton />
  
  
  <Schema
    item={{
      '@context': 'https://schema.org',
      '@type': 'BlogPosting',
      headline: post.data.title,
      description: post.data.description,
      author: {
        '@type': 'Organization',
        name: BUSINESS_INFO.name,
        url: BUSINESS_INFO.url,
        logo: BUSINESS_INFO.logo
      },
      publisher: {
        '@type': 'Organization',
        name: BUSINESS_INFO.name,
        logo: {
          '@type': 'ImageObject',
          url: BUSINESS_INFO.logo
        }
      },
      datePublished: post.data.publishDate.toISOString(),
      dateModified: post.data.publishDate.toISOString(),
      keywords: post.data.tags.join(', '),
      url: postUrl,
      image: ogImage || defaultOgImage,
      mainEntityOfPage: {
        '@type': 'WebPage',
        '@id': postUrl
      },
      about: [
        {
          '@type': 'Service',
          name: 'Garage Door Repair',
          provider: {
            '@type': 'LocalBusiness',
            name: BUSINESS_INFO.name,
            address: {
              '@type': 'PostalAddress',
              streetAddress: BUSINESS_INFO.address.streetAddress,
              addressLocality: BUSINESS_INFO.address.addressLocality,
              addressRegion: BUSINESS_INFO.address.addressRegion,
              postalCode: BUSINESS_INFO.address.postalCode,
              addressCountry: BUSINESS_INFO.address.addressCountry
            }
          }
        }
      ]
    }}
  />
</Base>